---
title: "Data Cleaning & Exploratory Graphs"
author: "Eva Wu"
output: github_document
date: "2022-06-27"
---

```{r setup, include = FALSE}
library(tidyverse)
library(colorspace)
library(kableExtra)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

## Data Cleaning

This code chunk is to import concatenated data, delete irrelevant variables and metadata to prepare for further data cleaning.

```{r load}
# jspsych data
df_j <- read_csv("inst-cat-uc-2.csv") %>% # load exp1 data
  filter(designation != "NA" & designation != "practice-intro" & designation != "practice-resp" & 
         qualtrics_id != "NA") %>%
  select(participant, qualtrics_id, chord, designation, response, # delete meta data
         correct, passed_practice, block_passed_practice, practice_score, 
         instrument, envelope, harmonics, tuning_step, selected_major, explicit_rtg) %>% 
  mutate(instrument = factor(instrument, levels = c("xylophone", "trumpet", "piano", "violin", "oboe")))

# qualtrics data
df_q <- read_csv("Qualtrics_5:4.csv") %>%
  filter(row_number() > 7) %>% # delete pilot data
  select(-(2:16), -50) %>% # delete unnecessary meta data
  mutate(Age = as.numeric(Age),
         Year = factor(Year, levels = c("Freshman", "Sophomore", "Junior", "Senior", "Graduate", "Other (please specify):")),
         Inst = as.integer(if_else(Inst == "Yes", 1, 0)),
         Start = if_else(Start == "10 Years Old", "10", Start), # so that this won't be coerced to NA when mutating to numeric; only this one didn't write an integer in this question
         Start = as.integer(Start),
         Inst_now = as.integer(if_else(Inst_now == "Yes", 1, 0)),
         Ens = as.integer(if_else(Ens == "Yes", 1, 0)),
         Course = as.integer(if_else(Course == "Yes", 1, 0)),
         Read = as.integer(if_else(Read == "Yes", 1, 0)),
         `Pitch&Tempo_1` = as.integer(`Pitch&Tempo_1`),
         `Pitch&Tempo_2` = as.integer(`Pitch&Tempo_2`),
         Perf = as.integer(case_when(Perf == "Yes" ~ 1,
                                     Perf == "No" ~ 0,
                                     Perf == "Not sure" ~ -1)),
         Concert = as.integer(Concert))

# join qualtrics & jspsych data by embedded qualtrics id
# discard those who do not have a matching qualtrics_id in qualtrics data, keep everyone in jspsych data
combined <- left_join(df_j, df_q, by = c("participant" = "jspsych_id"))
```

This code chunk is to filter out participants who did not do anything in the survey/categorization task. Since there were problems with SONA, some participants had duplicate rows, one with data and the other without. Others had two rows, one with Qualtrics response but blank jspsych response, the other with filled jspsych response but blank Qualtrics response. This step is to make sure we delete duplicates and combine same participants' Qualtrics and jspsych data into one row.

```{r clean-na}
# those who only have j data but not q
na_q <- combined %>%
  filter(is.na(Gender)) %>%
  select(1:15) # delete q columns
# there are 4 of them w/ blank qualtrics data but full jspsych data

# those who only have q data but not j
na_j <- df_q %>%
  # assume 22-0159 in q is 5281kj47nhoboj in j
  mutate(jspsych_id = if_else(jspsych_id == "22-0159", "5281kj47nhoboj", jspsych_id)) %>% 
  semi_join(na_q, by = c("jspsych_id" = "participant"))

# join the half-full data together according to jspsych id
na_combined <- full_join(na_q, na_j, by = c("participant" = "jspsych_id"), keep = TRUE) %>%
  select(-participant.y) %>%
  rename(participant = participant.x)

# bind them back to combined, delete the half-full rows (those whose gender was NA)
combined_drop_na <- rbind(combined, na_combined) %>%
  filter(!is.na(Gender))
```

The following code chunk is to extract demographics and headphone test data, combine them together, and filter out those who did not pass the headphone test.

```{r demo-headphone}
# df for demographics
# need to find a way to summarize musical expertise
demo <- combined_drop_na %>%
  filter(designation == "PRACTICE-PASSED-SUMMARY") %>%
  select(-1, -(3:6), -(10:16), -49) # delete unnecessary data

# df for headphone test
test <- combined_drop_na %>%
  filter(designation == "headphone-test") %>%
  select(2, 6) %>%
  group_by(qualtrics_id) %>%
  summarize(n = sum(correct)) %>%
  # set 4 out of 6 as passed headphone test
  mutate(headphone = if_else(n >= 4, 1, 0),
         test_corr = n) %>%
  select(-n)

# combine headphone test pass/fail result w/ original data
demo_test <- left_join(demo, test, by = "qualtrics_id")

# see how many failed the headphone test
test %>%
  filter(headphone == 0)
```

Setting 4 as the pass threshold, we can see that 8 participants did not pass the headphone test (answered fewer than 4 questions correctly). For now I'll keep them, but later we can see if deleting them makes a big difference, and then decide whether to keep them.

The following code chunk extracts categorization and explicit rating data respectively, and manipulate them to create 2 new data frames, 1 with participants' categorization with explicit ratings combined ([cat_rtg.csv](cat_rtg.csv)), the other with participants' demographics and average percent of major categorization and explicit rating of each instrument combined ([pivoted_data.csv](pivoted_data.csv)).

```{r cat-rtg}
# df for categorization
cat <- combined_drop_na %>%
  filter(designation == "MAIN-JUDGMENT") %>%
  select(2:3, 10:13) %>%
  group_by(qualtrics_id, instrument, tuning_step) %>%
  summarize(pct_maj = mean(selected_major))
  
# each person's mean major choice proportion 
cat_pivoted <- cat %>%
  group_by(qualtrics_id, instrument) %>%
  summarize(mean_cat = mean(pct_maj)) %>%
  mutate(instrument = paste0("cat_", instrument)) %>%
  pivot_wider(names_from = instrument, values_from = mean_cat)

# delete since no point of having 25 cols for major judgment
# pivot_wider(names_from = c(instrument, tuning_step), values_from = pct_maj)

# df for explicit rating
rtg <- combined_drop_na %>%
  filter(designation == "INST-VALENCE-RTG") %>%
  select(qualtrics_id, instrument, explicit_rtg)

# pivot so that one person has one row
rtg_pivoted <- rtg %>%
  mutate(instrument = paste0("rtg_", instrument)) %>%
  pivot_wider(names_from = instrument, values_from = explicit_rtg)

# df for both combined
cat_rtg <- left_join(cat, rtg)

# each instrument's mean cat & rtg
cat_rtg_summary <- cat_rtg %>%
  group_by(instrument) %>%
  summarize(mean_pct = mean(pct_maj),
         mean_rtg = mean(explicit_rtg))

# both pivoted combined
cat_rtg_pivoted <- cat_pivoted %>% 
  left_join(rtg_pivoted, by = c("qualtrics_id"))

# delete the following since no need
# mutate(inst_id = case_when(instrument == "oboe" ~ 1, instrument == "violin" ~ 2,
# instrument == "piano" ~ 3, instrument == "trumpet" ~ 4, instrument == "xylophone" ~ 5))

# each participant = 1 row of data
all <- left_join(cat_rtg_pivoted, demo_test)

write_csv(cat_rtg, "cat_rtg.csv")
write_csv(all, "pivoted_data.csv")
```

A snapshot of the data (next step: find a measure to summarize musical background)

```{r present}
variable_names = colnames(all)
variable_meaning = c("Random 10-digit ID assigned by Qualtrics, used to join Qualtrics and jspsych data", "Proportion of major categorization for xylophone", "Proportion of major categorization for violin", "Proportion of major categorization for piano",
                "Proportion of major categorization for trumpet", "Proportion of major categorization for oboe",
                "Explicit valence rating of xylophone", "Explicit valence rating of violin", "Explicit valence rating of piano",
                "Explicit valence rating of trumpet", "Explicit valence rating of oboe", "Passed practice or not (1 = pass)", "Number of tries taken to pass", 
                "Practice score (out of 12)", "", "", "", "If not a student or faculty", "", "If not a psych of music major", "Play instrument or not", 
                "At what age did they start playing an instrument", "Still playing now?", "List instruments played", "Participated in ensemble or not",
                "Taken music courses or not", "List music courses taken", "Read music or not", "Ability to perceive and remember pitch", "Ability to perceive and remember tempo",
                "Perfect pitch", "Time spent making music per week", "Time spent listening to music per day", "Number of concert attended per year", 
                "Proportion of each genre listened to (total 100)", "", "", "", "", "", "", "", "", "", "", "", "Passed headphone test or not (1 = pass)", 
                "Number of correct answers in headphone test")
codebook <- data.frame(variable_names, variable_meaning)
kable(codebook)
```

## Demographic analysis

```{r demo}
all %>%
  filter(Gender != "NA") %>%
  ggplot(aes(Gender, fill = Gender)) +
  geom_bar() +
  labs(title = "Participant gender distribution",
       x = "Gender",
       y = "Number of participants") +
  theme_minimal() +
  theme(legend.position = "None")

all %>%
  ggplot(aes(Age)) +
  geom_bar(fill = "lightblue") +
  labs(title = "Participant age distribution",
       x = "Age",
       y = "Number of participants") +
  theme_minimal()

all %>%
  filter(Year != "NA") %>%
  ggplot(aes(Year)) +
  geom_bar(fill = "orange") +
  labs(title = "Participant year of school distribution",
       x = "Year",
       y = "Number of participants") +
  theme_minimal()


# 3 psych, 3 double, 43 other; why is the graph like this
all %>%
  mutate(Major = case_when(Major == "Psychology" ~ "Psychology",
                           Major == "Music" ~ "Music",
                           Major == "NA" ~ "NA",
                           Major == "Music,Other (please specify):" ~ "Double major in music and another subject",
                           Major == "Other (please specify):" ~ "Other",
                           Major == "Psychology,Other (please specify):" ~ "Double major in psychology and another subject")) %>%
  ggplot(aes("", Major, fill = Major)) +
  geom_bar(stat = "identity") +
  coord_polar(theta = "y") +
  labs(title = "Participant major distribution") +
  theme_void()
```

Turns out the number of female and male participants did not differ much. 
Most participants were aged 18-21, while a few above 22. 
We had the greatest number of sophomores, then freshmen, then juniors, and the lowest number of seniors. 
Pie chart was a bit odd; need more work. But we can see that most participants were neither a psychology major nor a music major.

## Music courses taken

```{r musical-background}
# demo$Course is already an integer, why is it still double in the graph
#all %>%
#  ggplot(aes("", Course, fill = Course)) +
#  geom_bar(stat = "identity") +
#  coord_polar(theta = "y") +
#  labs(title = "Taken music courses or not") +
#  theme_void()

all %>%
  ggplot(aes(Course)) +
  geom_bar() +
  labs(title = "Taken music courses or not")
```

The number of participants who have taken music courses were slightly lower than that of those who haven't.

## Practice Score

```{r practice}
all %>%
  filter(block_passed_practice == 2)

all %>%
  ggplot(aes(practice_score)) +
  geom_bar(fill = "lightgreen") +
  labs(title = "Practice score distribution among those who passed (almost all did)",
       subtitle = "Pass: getting ≥ 8 out of 12 correct",
       x = "Number of correct responses out of 12",
       y = "Number of participants") +
  theme_minimal()
```

Only 2 failed the 1st time. The rest all passed in the 1st try. Most passed with 12/12.

## Categorization

```{r cat}
cat %>%
  ggplot(aes(tuning_step, pct_maj, color = instrument)) +
  geom_smooth(se = FALSE) +
  scale_y_continuous(labels = scales::percent) +
  # need to come up w/ a better palette
  # scale_color_discrete_sequential("Viridis", rev = TRUE) + 
  labs(title = "Proportion of major choices vs. tuning step & instruments",
       x = "Tuning step", y = "Percept of major choices") +
  theme_minimal()
```

Xylophone: overall most likely to be judged as major when tuning is unclear

Oboe: overall most likely to be judged as minor when tuning is unclear

## Explicit Rating

```{r rating}
rtg %>%
  ggplot(aes(instrument, explicit_rtg, fill = instrument)) +
  geom_col() +
  labs(title = "Explicit valence rating for each instrument",
       x = "Instrument", y = "Mean rating") +
  theme_minimal() +
  theme(legend.position = "None")
```

Xylophone: rated "happiest" on average, then piano, then trumpet, then oboe, and violin rated the "saddest".

## Compare trend between tonality judgment and explicit rating

```{r compare-cat-valence}
cat_rtg_summary %>%
  pivot_longer(cols = c(mean_pct, mean_rtg), names_to = "type", values_to = "value") %>%
  mutate(type = if_else(type == "mean_pct", "Mean percent proportion of major categorization", 
                        "Mean explicit valence rating")) %>%
  ggplot(aes(instrument, value, group = 1, color = type)) +
  geom_line() +
  facet_wrap(~type, ncol = 1, scales = "free_y") +
  labs(title = "Compare trend b/w tonality categorization & valence rating",
       x = "Instrument", y = NULL) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "None")
```

Trend for categorization is similar to that for explicit rating. But there was a tiny bit of difference:

Explicit valence rating: violin lowest, violin < oboe

Categorization: oboe lowest, violin > oboe
